<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lune Report Widget</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: transparent;
        color: #0f172a;
      }
      .frame {
        padding: 18px;
      }
      .card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
      }
      .title {
        font-size: 16px;
        font-weight: 600;
      }
      .subtitle {
        font-size: 12px;
        color: #64748b;
      }
      .badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 999px;
        background: #e2e8f0;
        color: #475569;
      }
      .grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
        padding: 16px;
      }
      .panel {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        padding: 14px 16px;
      }
      .panel h3 {
        margin: 0 0 8px;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #64748b;
      }
      .summary-list {
        margin: 0;
        padding-left: 18px;
        font-size: 14px;
        color: #0f172a;
      }
      .summary-list li + li {
        margin-top: 6px;
      }
      .sentiment {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        padding: 6px 10px;
        background: #f1f5f9;
        border-radius: 999px;
        font-size: 12px;
        color: #334155;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        background: #e2e8f0;
        color: #334155;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
      }
      .ratings {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .radar-wrap {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px 0;
      }
      .notes {
        font-size: 12px;
        color: #475569;
        line-height: 1.4;
      }
      .use-case {
        display: grid;
        gap: 6px;
        font-size: 13px;
        color: #1e293b;
      }
      .use-case strong {
        font-weight: 600;
        color: #0f172a;
      }
      .fallback {
        padding: 18px;
        color: #b91c1c;
        font-size: 13px;
      }
      @media (max-width: 820px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="frame">
      <div class="card" id="report-card">
        <header>
          <div>
            <div class="title" id="report-title">Report</div>
            <div class="subtitle" id="report-subtitle"></div>
          </div>
          <div class="badge" id="report-badge" style="display: none;">Example</div>
        </header>
        <div class="grid">
          <section class="panel">
            <h3>Executive summary</h3>
            <ul class="summary-list" id="exec-summary"></ul>
            <div style="margin-top: 10px;">
              <span class="sentiment" id="sentiment-pill"></span>
            </div>
          </section>
          <aside class="panel">
            <h3>Tools used</h3>
            <div class="chips" id="tools-used"></div>
          </aside>
          <section class="panel">
            <h3>Use case</h3>
            <div class="use-case" id="use-case"></div>
          </section>
          <aside class="panel">
            <h3>Ratings</h3>
            <div class="ratings">
              <div class="radar-wrap">
                <svg id="radar-chart" width="190" height="190" viewBox="0 0 200 200"></svg>
              </div>
              <div class="notes" id="ratings-notes"></div>
            </div>
          </aside>
        </div>
      </div>
      <div class="fallback" id="fallback" style="display: none;">
        Report data was missing or invalid.
      </div>
    </div>

    <script>
      function notifySize() {
        if (window.openai && typeof window.openai.notifyIntrinsicHeight === "function") {
          window.openai.notifyIntrinsicHeight();
        }
      }

      function getReportData() {
        const output = window.openai && window.openai.toolOutput ? window.openai.toolOutput : {};
        const report =
          output.report ||
          output.report_final ||
          output.report_model ||
          output.reportFinal ||
          output.reportModel;
        return { report, isExample: Boolean(output.is_example) };
      }

      function createRadar(svg, values) {
        const size = 200;
        const center = size / 2;
        const radius = 70;
        const levels = 5;
        const angleStep = (Math.PI * 2) / values.length;

        function point(angle, scale) {
          return [
            center + Math.cos(angle) * radius * scale,
            center + Math.sin(angle) * radius * scale,
          ];
        }

        const gridGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
        for (let i = 1; i <= levels; i += 1) {
          const scale = i / levels;
          const points = values.map((_, idx) => {
            const angle = -Math.PI / 2 + angleStep * idx;
            return point(angle, scale);
          });
          const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
          polygon.setAttribute(
            "points",
            points.map((p) => p.join(",")).join(" ")
          );
          polygon.setAttribute("fill", "none");
          polygon.setAttribute("stroke", "#e2e8f0");
          polygon.setAttribute("stroke-width", "1");
          gridGroup.appendChild(polygon);
        }

        const dataPoints = values.map((value, idx) => {
          const angle = -Math.PI / 2 + angleStep * idx;
          const scale = Math.max(0, Math.min(1, value / 5));
          return point(angle, scale);
        });
        const dataPolygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        dataPolygon.setAttribute(
          "points",
          dataPoints.map((p) => p.join(",")).join(" ")
        );
        dataPolygon.setAttribute("fill", "rgba(34,197,94,0.25)");
        dataPolygon.setAttribute("stroke", "#22c55e");
        dataPolygon.setAttribute("stroke-width", "2");

        svg.innerHTML = "";
        svg.appendChild(gridGroup);
        svg.appendChild(dataPolygon);
      }

      function renderReport() {
        const { report, isExample } = getReportData();
        const card = document.getElementById("report-card");
        const fallback = document.getElementById("fallback");

        if (!report) {
          card.style.display = "none";
          fallback.style.display = "block";
          notifySize();
          return;
        }

        document.getElementById("report-title").textContent = `Report: ${report.meta?.interview_id || "Session"}`;
        document.getElementById("report-subtitle").textContent = report.meta?.generated_at_iso
          ? `Generated ${new Date(report.meta.generated_at_iso).toLocaleString()}`
          : "";
        const badge = document.getElementById("report-badge");
        badge.style.display = isExample ? "inline-flex" : "none";

        const execSummary = document.getElementById("exec-summary");
        execSummary.innerHTML = "";
        (report.exec_summary?.bullets || []).forEach((bullet) => {
          const li = document.createElement("li");
          li.textContent = bullet;
          execSummary.appendChild(li);
        });
        const sentiment = report.exec_summary?.overall_sentiment || "n/a";
        document.getElementById("sentiment-pill").textContent = `Overall sentiment: ${sentiment}`;

        const toolsWrap = document.getElementById("tools-used");
        toolsWrap.innerHTML = "";
        (report.tools_used || []).forEach((tool) => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = tool;
          toolsWrap.appendChild(chip);
        });

        const useCase = document.getElementById("use-case");
        useCase.innerHTML = "";
        const title = report.use_case?.title;
        const goal = report.use_case?.goal;
        const role = report.use_case?.chatgpt_enterprise_role;
        if (title) {
          const row = document.createElement("div");
          row.innerHTML = `<strong>Title</strong>: ${title}`;
          useCase.appendChild(row);
        }
        if (goal) {
          const row = document.createElement("div");
          row.innerHTML = `<strong>Goal</strong>: ${goal}`;
          useCase.appendChild(row);
        }
        if (role) {
          const row = document.createElement("div");
          row.innerHTML = `<strong>ChatGPT role</strong>: ${role}`;
          useCase.appendChild(row);
        }

        const ratings = report.ratings?.dimensions || [];
        const values = ratings.map((item) => Number(item.value || 0));
        const radar = document.getElementById("radar-chart");
        if (values.length) {
          createRadar(radar, values);
        } else {
          radar.innerHTML = "";
        }
        document.getElementById("ratings-notes").textContent = report.ratings?.notes || "";

        notifySize();
      }

      renderReport();
      window.addEventListener("resize", notifySize);
    </script>
  </body>
</html>
